name: Build and Push to Artifact Registry

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  build-and-push:
    # Only run if PR was actually merged
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-central1-docker.pkg.dev
      
    - name: Generate image tag
      id: image-tag
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
        IMAGE_NAME="us-central1-docker.pkg.dev/sparkle-labs-310106/mcp-server/${REPO_NAME}:${TIMESTAMP}"
        echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
        echo " Image: ${IMAGE_NAME}"
        
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ steps.image-tag.outputs.image_name }}
          us-central1-docker.pkg.dev/sparkle-labs-310106/mcp-server/${{ github.event.repository.name }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Deployment Summary
      run: |
        echo "###  Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.event.pull_request.head.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "- **PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Merged by**: @${{ github.event.pull_request.merged_by.login }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: \`${{ steps.image-tag.outputs.image_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Latest**: \`us-central1-docker.pkg.dev/sparkle-labs-310106/mcp-server/${{ github.event.repository.name }}:latest\`" >> $GITHUB_STEP_SUMMARY
