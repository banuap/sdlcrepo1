name: Deploy on PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    # Only run if PR was actually merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Trigger Operations Agent Deployment
      env:
        OPERATIONS_API_URL: http://136.116.239.143
      run: |
        echo " PR #${{ github.event.pull_request.number }} was merged into ${{ github.event.pull_request.base.ref }}"
        echo " Branch: ${{ github.event.pull_request.head.ref }}"
        echo " Repository: ${{ github.repository }}"
        echo " Merged by: ${{ github.event.pull_request.merged_by.login }}"
        echo ""
        echo " Triggering deployment via Operations Agent..."
        
        # Call operations agent API to trigger deployment
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST $OPERATIONS_API_URL/deploy/branch \
          -H "Content-Type: application/json" \
          -d "{
            \"repo_url\": \"https://github.com/${{ github.repository }}.git\",
            \"branch\": \"${{ github.event.pull_request.head.ref }}\"
          }")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)
        
        echo "Response Code: $HTTP_CODE"
        echo "Response Body: $BODY"
        
        if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
          echo " Deployment triggered successfully!"
        else
          echo " Deployment failed with HTTP code $HTTP_CODE"
          exit 1
        fi
